C++çš„æ™ºèƒ½æŒ‡é’ˆæ˜¯ç°ä»£C++ä¸­éå¸¸é‡è¦çš„ç‰¹æ€§ï¼Œä¸»è¦ç”¨äºè‡ªåŠ¨ç®¡ç†åŠ¨æ€å†…å­˜ï¼Œé¿å…å†…å­˜æ³„æ¼å’Œæ‚¬ç©ºæŒ‡é’ˆç­‰é—®é¢˜ã€‚

## ä¸‰ç§æ™ºèƒ½æŒ‡é’ˆï¼š
### std::unique_ptr
ç‹¬å æ‰€æœ‰æƒï¼Œä¸å…è®¸å¤åˆ¶ï¼Œä½†å¯ä»¥ç§»åŠ¨ã€‚é€‚åˆå•æ‰€æœ‰è€…åœºæ™¯ï¼Œæ¯”å¦‚ä¸´æ—¶å¯¹è±¡æˆ–å‡½æ•°è¿”å›å€¼ã€‚ä¼˜ç‚¹ï¼šè½»é‡ã€é«˜æ•ˆï¼Œæ€§èƒ½æ¥è¿‘åŸç”ŸæŒ‡é’ˆã€‚\
ç¤ºä¾‹ï¼š
```cpp
auto ptr = std::make_unique<int>(42);
```

### std::shared_ptr
å…±äº«æ‰€æœ‰æƒï¼Œé€šè¿‡å¼•ç”¨è®¡æ•°å®ç°ã€‚å¤šä¸ªæŒ‡é’ˆå¯ä»¥æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œå½“æœ€åä¸€ä¸ª shared_ptr è¢«é”€æ¯æ—¶ï¼Œè‡ªåŠ¨é‡Šæ”¾èµ„æºã€‚
é€‚åˆéœ€è¦å¤šä¸ªå¯¹è±¡å…±äº«åŒä¸€èµ„æºçš„åœºæ™¯ã€‚æ³¨æ„ï¼šæœ‰æ€§èƒ½å¼€é”€ï¼ˆå¼•ç”¨è®¡æ•°ï¼‰ï¼Œå¯èƒ½äº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚\
ç¤ºä¾‹ï¼š
```cpp
auto ptr1 = std::make_shared<int>(100);
auto ptr2 = ptr1; // å¼•ç”¨è®¡æ•°+1
```

### std::weak_ptr
ç”¨äºè§£å†³ shared_ptr çš„å¾ªç¯å¼•ç”¨é—®é¢˜ã€‚ä¸å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œåªèƒ½è§‚å¯Ÿ shared_ptr ç®¡ç†çš„å¯¹è±¡ã€‚ä½¿ç”¨å‰éœ€è°ƒç”¨ lock() è½¬ä¸º shared_ptrï¼Œé¿å…è®¿é—®å·²é‡Šæ”¾çš„å†…å­˜ã€‚\
ç¤ºä¾‹ï¼š
```cpp
std::weak_ptr<int> weak = ptr1;
if (auto shared = weak.lock()) {
    // å®‰å…¨ä½¿ç”¨
}
```

## æ™ºèƒ½æŒ‡é’ˆç”¨æ³•æ¼”ç¤º
åœºæ™¯ï¼šæ¨¡æ‹Ÿä¸€ä¸ªâ€œå›¾ä¹¦ç®¡ç†ç³»ç»Ÿâ€\
æˆ‘ä»¬æœ‰ï¼š
* ä¹¦ç±ï¼ˆBookï¼‰
* å›¾ä¹¦é¦†ï¼ˆLibraryï¼‰â€”â€”ç®¡ç†ä¹¦ç±
* è¯»è€…ï¼ˆReaderï¼‰â€”â€”å¯ä»¥å€Ÿä¹¦
è¦æ±‚ï¼š\
* ä¸€æœ¬ä¹¦åªèƒ½è¢«ä¸€ä¸ªå›¾ä¹¦é¦†æ‹¥æœ‰ï¼ˆç”¨ unique_ptrï¼‰
* è¯»è€…å¯ä»¥å€Ÿé˜…åŒä¸€æœ¬ä¹¦ï¼ˆå¤šä¸ªè¯»è€…å…±äº«ä¸€æœ¬ä¹¦ï¼Œç”¨ shared_ptrï¼‰
* è¯»è€…ä¸èƒ½æŒæœ‰å¯¹ä¹¦çš„å¼ºå¼•ç”¨ï¼ˆé¿å…å¾ªç¯å¼•ç”¨ï¼‰ï¼Œç”¨ weak_ptr è¡¨ç¤ºâ€œå€Ÿé˜…å…³ç³»â€

---

```cpp
#include <iostream>
#include <memory>
#include <string>
#include <vector>
#include <map>

// ä¹¦ç±ç±»
class Book {
public:
    std::string title;
    std::string author;

    Book(const std::string& t, const std::string& a) : title(t), author(a) {
        std::cout << "ğŸ“– ä¹¦ç±ã€Š" << title << "ã€‹è¢«åˆ›å»ºäº†ï¼\n";
    }

    ~Book() {
        std::cout << "ğŸ—‘ï¸ ä¹¦ç±ã€Š" << title << "ã€‹è¢«é”€æ¯äº†ã€‚\n";
    }

    void read() const {
        std::cout << "ğŸ“– æ­£åœ¨é˜…è¯»ã€Š" << title << "ã€‹ by " << author << "\n";
    }
};

// è¯»è€…ç±»ï¼šæŒæœ‰å¯¹ä¹¦çš„ weak_ptrï¼ˆå€Ÿé˜…å…³ç³»ï¼‰
class Reader {
private:
    std::string name;
    std::weak_ptr<Book> borrowed_book; // ä¸æ‹¥æœ‰ï¼Œåªæ˜¯è§‚å¯Ÿ

public:
    Reader(const std::string& n) : name(n) {}

    void borrow(std::shared_ptr<Book> book) {
        borrowed_book = book;
        std::cout << "ğŸ‘¤ è¯»è€… " << name << " å€Ÿé˜…äº†ã€Š" << book->title << "ã€‹\n";
    }

    void read() {
        if (auto book = borrowed_book.lock()) { // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ•ˆ
            book->read();
        } else {
            std::cout << "âŒ è¯»è€… " << name << " æƒ³è¯»çš„ä¹¦å·²å½’è¿˜æˆ–è¢«é”€æ¯ã€‚\n";
        }
    }
};

// å›¾ä¹¦é¦†ç±»ï¼šæ‹¥æœ‰ä¹¦ç±çš„æ‰€æœ‰æƒï¼ˆç”¨ unique_ptrï¼‰
class Library {
private:
    std::string name;
    std::vector<std::unique_ptr<Book>> books; // ä¸“å±æ‹¥æœ‰

public:
    Library(const std::string& n) : name(n) {}

    // æ·»åŠ ä¸€æœ¬ä¹¦ï¼ˆå›¾ä¹¦é¦†ç‹¬å æ‰€æœ‰æƒï¼‰
    void addBook(std::unique_ptr<Book> book) {
        books.push_back(std::move(book));
        std::cout << "ğŸ“š å›¾ä¹¦é¦† " << name << " æ–°å¢ä¹¦ç±ï¼šã€Š" << books.back()->title << "ã€‹\n";
    }

    // ä¸ºè¯»è€…æä¾›å…±äº«çš„ä¹¦ï¼ˆshared_ptrï¼‰
    std::shared_ptr<Book> getBook(const std::string& title) {
        for (auto& book : books) {
            if (book->title == title) {
                // è¿”å› shared_ptrï¼Œè®©è¯»è€…å¯ä»¥å…±äº«
                return std::shared_ptr<Book>(book.get()); // æ³¨æ„ï¼šè¿™é‡Œåªä¼ é€’è£¸æŒ‡é’ˆï¼Œä½†ä¼šå…±äº«å¼•ç”¨è®¡æ•°
            }
        }
        std::cout << "âŒ å›¾ä¹¦é¦† " << name << " æ²¡æœ‰æ‰¾åˆ°ã€Š" << title << "ã€‹\n";
        return nullptr;
    }

    // é‡Šæ”¾æ‰€æœ‰ä¹¦ï¼ˆè‡ªåŠ¨é”€æ¯ï¼‰
    ~Library() {
        std::cout << "ğŸ›ï¸ å›¾ä¹¦é¦† " << name << " å…³é—­ï¼Œæ‰€æœ‰ä¹¦ç±å·²å½’è¿˜ã€‚\n";
    }
};

// ä¸»å‡½æ•°ï¼šæ¼”ç¤ºä¸‰è€…åä½œ
int main() {
    // 1. åˆ›å»ºå›¾ä¹¦é¦†ï¼Œç”¨ unique_ptr ç®¡ç†ä¹¦ç±
    auto library = std::make_unique<Library>("å¸‚ç«‹å›¾ä¹¦é¦†");

    // 2. æ·»åŠ å‡ æœ¬ä¹¦ï¼ˆunique_ptr ç®¡ç†ï¼‰
    library->addBook(std::make_unique<Book>("C++ Primer", "Stanley Lippman"));
    library->addBook(std::make_unique<Book>("Effective C++", "Scott Meyers"));

    // 3. åˆ›å»ºè¯»è€…
    auto reader1 = std::make_shared<Reader>("å°æ˜");
    auto reader2 = std::make_shared<Reader>("å°çº¢");

    // 4. è¯»è€…å€Ÿä¹¦ï¼ˆé€šè¿‡ shared_ptr å…±äº«ï¼‰
    auto book1 = library->getBook("C++ Primer");
    if (book1) {
        reader1->borrow(book1); // å°æ˜å€Ÿä¹¦
        reader2->borrow(book1); // å°çº¢ä¹Ÿå€ŸåŒä¸€æœ¬ä¹¦
    }

    // 5. è¯»è€…é˜…è¯»
    reader1->read(); // âœ… æ­£å¸¸è¯»
    reader2->read(); // âœ… æ­£å¸¸è¯»

    // 6. å›¾ä¹¦é¦†è¢«é”€æ¯ï¼ˆunique_ptr é‡Šæ”¾ï¼‰
    // è¿™ä¼šè§¦å‘ books çš„é”€æ¯ï¼Œä½†å› ä¸º book1 æ˜¯ shared_ptrï¼Œæ‰€ä»¥ä¹¦ä¸ä¼šè¢«ç«‹å³é”€æ¯
    // åªæœ‰å½“æ‰€æœ‰ shared_ptr å’Œ weak_ptr éƒ½é‡Šæ”¾åï¼Œä¹¦æ‰çœŸæ­£é”€æ¯

    // 7. é‡Šæ”¾è¯»è€…ï¼ˆä½†ä¹¦è¿˜åœ¨ï¼Œå› ä¸º shared_ptr è¿˜åœ¨ï¼‰
    reader1.reset();
    reader2.reset();

    // 8. å†æ¬¡å°è¯•è¯»ï¼ˆæ­¤æ—¶ä¹¦å¯èƒ½å·²è¢«é‡Šæ”¾ï¼‰
    std::cout << "\nâ¡ï¸ è¯»è€…å·²é‡Šæ”¾ï¼Œå°è¯•å†æ¬¡é˜…è¯»...\n";
    reader1 = std::make_shared<Reader>("å°æ˜");
    reader1->read(); // âŒ ä¹¦å·²é”€æ¯ï¼Œweak_ptr æ— æ³•è·å–

    return 0;
}
```

#### è¾“å‡ºç»“æœï¼š
```
ğŸ“– ä¹¦ç±ã€ŠC++ Primerã€‹è¢«åˆ›å»ºäº†ï¼
ğŸ“– ä¹¦ç±ã€ŠEffective C++ã€‹è¢«åˆ›å»ºäº†ï¼
ğŸ“š å›¾ä¹¦é¦† å¸‚ç«‹å›¾ä¹¦é¦† æ–°å¢ä¹¦ç±ï¼šã€ŠC++ Primerã€‹
ğŸ“š å›¾ä¹¦é¦† å¸‚ç«‹å›¾ä¹¦é¦† æ–°å¢ä¹¦ç±ï¼šã€ŠEffective C++ã€‹
ğŸ‘¤ è¯»è€… å°æ˜ å€Ÿé˜…äº†ã€ŠC++ Primerã€‹
ğŸ‘¤ è¯»è€… å°çº¢ å€Ÿé˜…äº†ã€ŠC++ Primerã€‹
ğŸ“– æ­£åœ¨é˜…è¯»ã€ŠC++ Primerã€‹ by Stanley Lippman
ğŸ“– æ­£åœ¨é˜…è¯»ã€ŠC++ Primerã€‹ by Stanley Lippman

ğŸ›ï¸ å›¾ä¹¦é¦† å¸‚ç«‹å›¾ä¹¦é¦† å…³é—­ï¼Œæ‰€æœ‰ä¹¦ç±å·²å½’è¿˜ã€‚

ğŸ—‘ï¸ ä¹¦ç±ã€ŠC++ Primerã€‹è¢«é”€æ¯äº†ã€‚
ğŸ—‘ï¸ ä¹¦ç±ã€ŠEffective C++ã€‹è¢«é”€æ¯äº†ã€‚

â¡ï¸ è¯»è€…å·²é‡Šæ”¾ï¼Œå°è¯•å†æ¬¡é˜…è¯»...
âŒ è¯»è€… å°æ˜ æƒ³è¯»çš„ä¹¦å·²å½’è¿˜æˆ–è¢«é”€æ¯ã€‚
```
---

### ä¸‰è€…ç”¨æ³•æ€»ç»“

| æ™ºèƒ½æŒ‡é’ˆ | ç”¨æ³• | ä½œç”¨ | ä½•æ—¶ç”¨ |
|--------|------|------|--------|
| `std::unique_ptr` | `std::make_unique<Book>(...)`<br>`library->addBook(std::move(book))` | **ç‹¬å æ‰€æœ‰æƒ**ï¼Œè‡ªåŠ¨é”€æ¯ | ç®¡ç†å•ä¸ªå¯¹è±¡ï¼Œå¦‚å®¹å™¨ã€ä¸´æ—¶èµ„æº |
| `std::shared_ptr` | `std::make_shared<Book>(...)`<br>`library->getBook(...)` | **å…±äº«æ‰€æœ‰æƒ**ï¼Œå¼•ç”¨è®¡æ•° | å¤šä¸ªå¯¹è±¡éœ€è¦å…±äº«åŒä¸€èµ„æº |
| `std::weak_ptr` | `std::weak_ptr<Book> borrowed_book;`<br>`if (auto book = weak.lock())` | **è§‚å¯Ÿå…±äº«å¯¹è±¡**ï¼Œä¸å¢åŠ å¼•ç”¨è®¡æ•° | é¿å…å¾ªç¯å¼•ç”¨ï¼Œè¡¨ç¤ºâ€œå€Ÿé˜…â€â€œè§‚å¯Ÿâ€å…³ç³» |

### å…³é”®ç‚¹æé†’ï¼š
- `shared_ptr` çš„å¼•ç”¨è®¡æ•°æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ“ä½œæœ‰å¼€é”€ã€‚
- `weak_ptr` åªèƒ½é€šè¿‡ `lock()` è½¬ä¸º `shared_ptr`ï¼Œå¦åˆ™ä¸èƒ½è®¿é—®ã€‚
- `unique_ptr` ä¸èƒ½å¤åˆ¶ï¼Œåªèƒ½ç§»åŠ¨ï¼Œæ€§èƒ½æœ€å¥½ã€‚
- **ä¸è¦ç”¨ `shared_ptr` ç®¡ç† `unique_ptr` ç®¡ç†çš„å¯¹è±¡**ï¼Œå¦åˆ™ä¼šé‡å¤é‡Šæ”¾ï¼

